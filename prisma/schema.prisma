// ===========================================
// SideProject.deals â€” Database Schema
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS
// ============================================

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  username        String    @unique
  passwordHash    String
  
  // Profile
  displayName     String?
  bio             String?   @db.Text
  avatarUrl       String?
  websiteUrl      String?
  twitterHandle   String?
  githubHandle    String?
  
  // Stripe Connect (for sellers)
  stripeAccountId   String?   @unique
  stripeOnboarded   Boolean   @default(false)
  stripePayoutsEnabled Boolean @default(false)
  
  // Status & Verification
  emailVerified     DateTime?
  emailVerifyToken  String?
  passwordResetToken String?
  passwordResetExpires DateTime?
  
  // Trust
  isVerifiedSeller  Boolean   @default(false)
  verifiedAt        DateTime?
  
  // Admin
  isAdmin           Boolean   @default(false)
  isBanned          Boolean   @default(false)
  bannedAt          DateTime?
  banReason         String?

  // Seller Tier (for limits and escrow)
  sellerTier        SellerTier @default(NEW)
  totalSales        Int        @default(0)
  totalDisputes     Int        @default(0)
  disputeRate       Float      @default(0)

  // Buyer Tier (for spend limits)
  buyerTier         BuyerTier  @default(NEW)
  totalPurchases    Int        @default(0)

  // Soft Delete
  deletedAt         DateTime?

  // Notification Preferences
  messageNotifications String @default("instant") // "instant" | "digest" | "off"

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  
  // Relations
  listings          Listing[]
  purchases         Purchase[]        @relation("BuyerPurchases")
  sales             Purchase[]        @relation("SellerSales")
  votes             Vote[]
  comments          Comment[]
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  reports           Report[]          @relation("ReportedBy")
  blockedUsers      BlockedUser[]     @relation("Blocker")
  blockedBy         BlockedUser[]     @relation("Blocked")
  buyerThreads      MessageThread[]   @relation("BuyerThreads")
  sellerThreads     MessageThread[]   @relation("SellerThreads")
  warnings          UserWarning[]

  @@index([email])
  @@index([username])
  @@index([stripeAccountId])
}

model BlockedUser {
  id          String   @id @default(cuid())
  
  blocker     User     @relation("Blocker", fields: [blockerId], references: [id])
  blockerId   String
  
  blocked     User     @relation("Blocked", fields: [blockedId], references: [id])
  blockedId   String
  
  createdAt   DateTime @default(now())
  
  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

// ============================================
// LISTINGS
// ============================================

model Listing {
  id                String    @id @default(cuid())
  slug              String    @unique
  
  // Basic Info
  title             String    @db.VarChar(100)
  shortDescription  String    @db.VarChar(280)
  description       String    @db.Text
  
  // Pricing
  priceType         PriceType @default(FIXED)
  priceInCents      Int?      // null for FREE or CONTACT
  minPriceInCents   Int?      // for PAY_WHAT_YOU_WANT
  
  // What's Included (structured)
  includesSourceCode    Boolean @default(true)
  includesDatabase      Boolean @default(false)
  includesDocs          Boolean @default(false)
  includesDeployGuide   Boolean @default(false)
  includesSupport       Boolean @default(false)
  supportDays           Int?    // e.g., 30 days
  includesUpdates       Boolean @default(false)
  includesCommercialLicense Boolean @default(true)
  includesWhiteLabel    Boolean @default(false)
  whatsIncludedCustom   String? @db.Text // additional items
  
  // Tech Stack
  techStack             String[] // array of tags
  
  // Links
  liveUrl               String?
  repoUrl               String?
  videoUrl              String?
  
  // Media
  screenshots           String[] // array of URLs
  thumbnailUrl          String?
  
  // Delivery
  deliveryMethod        DeliveryMethod @default(INSTANT_DOWNLOAD)
  deliveryTimeframeDays Int            @default(0) // 0 = instant
  
  // Categorization
  category              Category @relation(fields: [categoryId], references: [id])
  categoryId            String
  
  // Status
  status                ListingStatus @default(DRAFT)
  publishedAt           DateTime?
  
  // Featured
  featured              Boolean   @default(false)
  featuredUntil         DateTime?
  
  // Stats (denormalized for performance)
  viewCount             Int       @default(0)
  voteScore             Int       @default(0) // upvotes - downvotes
  upvoteCount           Int       @default(0)
  downvoteCount         Int       @default(0)
  commentCount          Int       @default(0)
  purchaseCount         Int       @default(0)
  
  // Ownership
  seller                User      @relation(fields: [sellerId], references: [id])
  sellerId              String
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Soft Delete (seller-initiated)
  deletedAt             DateTime?

  // Relations
  files                 ListingFile[]
  purchases             Purchase[]
  votes                 Vote[]
  comments              Comment[]
  messages              Message[]
  reports               Report[]
  views                 ListingView[]
  featuredPurchases     FeaturedPurchase[]
  threads               MessageThread[]    @relation("ThreadListing")

  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@index([voteScore])
  @@index([publishedAt])
  @@index([deletedAt])
}

model ListingFile {
  id          String   @id @default(cuid())
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId   String

  fileName    String
  fileSize    Int      // bytes
  fileKey     String   // R2/S3 object key
  mimeType    String?

  // VirusTotal scanning
  fileHash      String?      // SHA256 hash
  scanStatus    ScanStatus   @default(PENDING)
  scanResult    Json?        // Full VT response
  scannedAt     DateTime?
  detections    Int          @default(0)  // Number of engines detecting threats
  totalEngines  Int          @default(0)  // Total engines that scanned
  vtAnalysisId  String?      // VT analysis ID for polling

  createdAt   DateTime @default(now())

  @@index([listingId])
  @@index([scanStatus])
}

enum PriceType {
  FREE
  FIXED
  PAY_WHAT_YOU_WANT
  CONTACT
}

enum DeliveryMethod {
  INSTANT_DOWNLOAD    // Files on platform
  REPOSITORY_ACCESS   // Seller adds to repo
  MANUAL_TRANSFER     // Seller sends manually
  DOMAIN_TRANSFER     // Domain/account transfer
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD          // One-time sale, now unavailable
  ARCHIVED      // Seller took down
  REMOVED       // Platform removed
}

// ============================================
// CATEGORIES
// ============================================

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  icon        String?   // emoji
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  
  listings    Listing[]
  
  @@index([slug])
  @@index([sortOrder])
}

// ============================================
// PURCHASES / TRANSACTIONS
// ============================================

model Purchase {
  id                String   @id @default(cuid())
  
  // What was bought
  listing           Listing  @relation(fields: [listingId], references: [id])
  listingId         String
  
  // Who bought it
  buyer             User?    @relation("BuyerPurchases", fields: [buyerId], references: [id])
  buyerId           String?  // null for guest checkout
  guestEmail        String?  // for guest checkout
  
  // Who sold it
  seller            User     @relation("SellerSales", fields: [sellerId], references: [id])
  sellerId          String
  
  // Payment details
  amountPaidCents   Int      // what buyer paid
  platformFeeCents  Int      // our cut
  sellerAmountCents Int      // what seller gets (before Stripe fees)
  
  // Stripe references
  stripePaymentIntentId String?  @unique
  stripeCheckoutSessionId String? @unique
  stripeTransferId  String?  // transfer to seller's connected account
  
  // Status
  status            PurchaseStatus @default(PENDING)
  
  // Delivery tracking
  deliveryStatus    DeliveryStatus @default(PENDING)
  deliveredAt       DateTime?
  deliveryNotes     String?  // seller can add notes
  buyerConfirmedAt  DateTime? // buyer marked as received
  
  // Auto-complete after X days
  autoCompleteAt    DateTime?

  // Download limits
  downloadCount     Int @default(0)
  maxDownloads      Int @default(10)

  // Escrow
  escrowStatus      EscrowStatus @default(HOLDING)
  escrowExpiresAt   DateTime?
  escrowReleasedAt  DateTime?

  // Dispute
  disputedAt        DateTime?
  disputeReason     DisputeReason?
  disputeNotes      String?        @db.Text
  resolvedAt        DateTime?
  resolvedBy        String?        // admin user ID
  resolution        String?        // explanation of resolution

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([escrowStatus])
}

enum PurchaseStatus {
  PENDING           // Payment initiated
  COMPLETED         // Payment successful
  FAILED            // Payment failed
  REFUNDED          // Seller issued refund
  DISPUTED          // Chargeback initiated
}

enum DeliveryStatus {
  PENDING           // Awaiting delivery
  DELIVERED         // Seller marked delivered
  CONFIRMED         // Buyer confirmed receipt
  AUTO_COMPLETED    // Auto-completed after X days
}

enum SellerTier {
  NEW               // 0 sales, 1 active listing max
  VERIFIED          // 1+ sales, 3 active listings max
  TRUSTED           // 3+ sales, 10 active listings max
  PRO               // 10+ sales or manually granted, unlimited
}

enum BuyerTier {
  NEW               // 0 purchases, $250/day limit
  VERIFIED          // 1+ purchases, $500/day limit
  TRUSTED           // 3+ purchases, $1000/day limit
}

enum EscrowStatus {
  HOLDING           // Funds held on platform
  DISPUTED          // Buyer opened dispute
  RELEASED          // Funds released to seller
  REFUNDED          // Funds refunded to buyer
}

enum DisputeReason {
  FILES_EMPTY       // Downloaded files were empty/corrupted
  NOT_AS_DESCRIBED  // Product doesn't match listing
  SELLER_UNRESPONSIVE // Seller not responding
  SUSPECTED_STOLEN  // Code appears stolen
  MALWARE           // Files contain malware
  OTHER             // Other reason
}

enum ScanStatus {
  PENDING           // Not yet scanned
  SCANNING          // Scan in progress (uploaded to VT)
  CLEAN             // No threats detected
  SUSPICIOUS        // Low threat score, review needed
  MALICIOUS         // High threat score, blocked
  ERROR             // Scan failed
  SKIPPED           // File type not scannable
}

// ============================================
// VOTES (Thumbs Up / Thumbs Down)
// ============================================

model Vote {
  id          String   @id @default(cuid())
  
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId   String
  
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  
  // +1 for upvote, -1 for downvote
  value       Int      // 1 or -1
  
  // Did they actually buy it?
  isVerifiedPurchase Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([listingId, userId]) // one vote per user per listing
  @@index([listingId])
  @@index([userId])
}

// ============================================
// COMMENTS
// ============================================

model Comment {
  id          String   @id @default(cuid())
  
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId   String
  
  author      User     @relation(fields: [authorId], references: [id])
  authorId    String
  
  // Content
  content     String   @db.Text
  
  // Threading (one level only)
  parentId    String?
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")
  
  // Trust signals
  isVerifiedPurchase Boolean @default(false)
  isSeller          Boolean @default(false) // auto-set if author is listing seller
  
  // Moderation
  isHiddenBySeller  Boolean @default(false)
  isRemoved         Boolean @default(false)
  removedReason     String?
  
  // Edit window
  canEditUntil      DateTime? // 15 min after creation
  editedAt          DateTime?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([listingId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
}

// ============================================
// MESSAGE THREADS (Explicit Thread Management)
// ============================================

model MessageThread {
  id            String        @id @default(cuid())

  // Participants
  buyer         User          @relation("BuyerThreads", fields: [buyerId], references: [id])
  buyerId       String

  seller        User          @relation("SellerThreads", fields: [sellerId], references: [id])
  sellerId      String

  // Context
  listing       Listing?      @relation("ThreadListing", fields: [listingId], references: [id])
  listingId     String?

  // Status
  status        ThreadStatus  @default(ACTIVE)

  // Suspension tracking
  suspendedAt   DateTime?
  suspendedBy   String?       // Admin user ID who suspended
  suspendReason String?       @db.Text

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  messages      Message[]
  warnings      UserWarning[]

  @@unique([buyerId, sellerId, listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@index([status])
}

enum ThreadStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

// ============================================
// USER WARNINGS (Admin Moderation)
// ============================================

model UserWarning {
  id          String         @id @default(cuid())

  // Who was warned
  user        User           @relation(fields: [userId], references: [id])
  userId      String

  // Context (optional - warning may be thread-specific)
  thread      MessageThread? @relation(fields: [threadId], references: [id])
  threadId    String?

  // Warning details
  reason      WarningReason
  notes       String?        @db.Text

  // Who issued it
  issuedBy    String         // Admin user ID

  // Timestamps
  createdAt   DateTime       @default(now())

  @@index([userId])
  @@index([threadId])
  @@index([createdAt])
}

enum WarningReason {
  INAPPROPRIATE
  HARASSMENT
  SCAM
  POLICY_VIOLATION
  OTHER
}

// ============================================
// MESSAGES (Direct Messages)
// ============================================

model Message {
  id          String   @id @default(cuid())

  // Thread reference
  thread      MessageThread? @relation(fields: [threadId], references: [id])
  threadId    String?

  // Conversation context (optional - can be general or about a listing)
  listing     Listing? @relation(fields: [listingId], references: [id])
  listingId   String?

  // Participants
  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  senderId    String

  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  receiverId  String

  // Content
  content     String   @db.Text

  // Attachments
  attachments MessageAttachment[]

  // Status
  readAt      DateTime?

  // Timestamps
  createdAt   DateTime @default(now())

  @@index([threadId])
  @@index([listingId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

model MessageAttachment {
  id         String   @id @default(cuid())

  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId  String

  fileName   String
  fileSize   Int      // bytes
  fileKey    String   // R2 object key
  mimeType   String?

  createdAt  DateTime @default(now())

  @@index([messageId])
}

// ============================================
// REPORTS (Community Moderation)
// ============================================

model Report {
  id          String     @id @default(cuid())
  
  // Who reported
  reporter    User       @relation("ReportedBy", fields: [reporterId], references: [id])
  reporterId  String
  
  // What was reported
  entityType  ReportEntityType
  
  // Reference to reported entity (polymorphic)
  listingId   String?
  listing     Listing?   @relation(fields: [listingId], references: [id])
  
  commentId   String?
  // Note: Add Comment relation if needed
  
  userId      String?    // if reporting a user directly
  
  // Report details
  reason      ReportReason
  details     String?    @db.Text
  
  // Status
  status      ReportStatus @default(PENDING)
  reviewedAt  DateTime?
  reviewedBy  String?    // admin user id
  resolution  String?
  
  // Timestamps
  createdAt   DateTime   @default(now())
  
  @@index([entityType, status])
  @@index([reporterId])
  @@index([listingId])
}

enum ReportEntityType {
  LISTING
  COMMENT
  USER
  MESSAGE
}

enum ReportReason {
  SPAM
  STOLEN_CODE
  MISLEADING
  SCAM
  MALWARE
  HARASSMENT
  ILLEGAL
  COPYRIGHT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTION_TAKEN
  DISMISSED
}

// ============================================
// AUDIT LOG (Admin)
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  
  // What happened
  action      String   // e.g., "listing.removed", "user.banned"
  entityType  String   // e.g., "listing", "user"
  entityId    String
  
  // Who did it
  actorId     String?  // admin user id, null for system actions
  
  // Details
  metadata    Json?    // additional context
  
  createdAt   DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([actorId])
  @@index([createdAt])
}

// ============================================
// FEATURED LISTING PURCHASES (Future)
// ============================================

model FeaturedPurchase {
  id          String   @id @default(cuid())
  
  listing     Listing  @relation(fields: [listingId], references: [id])
  listingId   String
  
  // Duration
  startDate   DateTime
  endDate     DateTime
  daysCount   Int
  
  // Payment
  amountPaidCents Int
  stripePaymentIntentId String? @unique
  
  // Status
  status      FeaturedStatus @default(ACTIVE)
  
  createdAt   DateTime @default(now())
  
  @@index([listingId])
  @@index([status, endDate])
}

enum FeaturedStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
  REFUNDED
}

// ============================================
// VIEWS (Optional - for analytics)
// ============================================

model ListingView {
  id          String   @id @default(cuid())
  
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId   String
  
  // Viewer (optional - can be anonymous)
  userId      String?
  
  // Fingerprint for anonymous deduplication
  fingerprint String?
  ipHash      String?  // hashed for privacy
  
  // Context
  referrer    String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([listingId])
  @@index([createdAt])
}

// Add relation to Listing model
// views ListingView[]

// Add relation to FeaturedPurchase in Listing
// featuredPurchases FeaturedPurchase[]
